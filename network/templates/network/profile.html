{% extends "network/layout.html" %}
{% load static %}
    
{% block body %}
    <div class="container border p-3">
        <h3 class="d-flex justify-content-center"><span class="text-info mx-1 text-capitalize">{{name}}</span> Profile</h3>
        <div class="d-flex justify-content-center">
            <div id="num_followers" class="bg-secondary text-white px-3 py-2 rounded mx-2">Followers {{followers}}</div>
            <div class="bg-secondary text-white px-3 py-2 rounded">Following {{followings}}</div>
        </div>
        {%if user.id != user_id%}
        <div class="d-flex justify-content-center my-3">
            <form id="follow_unfollow_user">
                <input type="text" value="{{user_id}}" hidden>
                {%if isFollowed%}
                    <button type="submit" id="follow_unfollow" class="btn btn-danger">Unfollow {{name}}</button>
                {%else%}
                    <button type="submit" id="follow_unfollow" class="btn btn-primary">Follow {{name}}</button>
                {%endif%}
            </form>
        </div>
        {%endif%}
        <div>
            <h3>All 
                {%if user.id == user_id%}
                    my    
                {%else%}
                    {{name}}
                {%endif%}
                posts: 
            </h3>
        </div>
        <div id="new_posts">
            {%if posts|length%}
                {%for post in posts%}
                <div class="border p-3 my-3" id="post-{{post.id}}">
                    <div>
                        <h3>
                            {%if user.id == post.poster.id%}
                            <a href="{%url 'me'%}">
                                You
                            </a>
                            {%else%}
                            <a href="{%url 'profile' post.poster%}-{{post.poster.id}}">
                                {{post.poster}}
                            </a>
                            {%endif%}
                        </h3>
                    </div>
                    {%if user.id == post.poster.id%}
                    <div>
                        <button type="button" class="btn btn-warning edit_btn">Edit</button>
                    </div>
                    {%endif%}
                    <div>
                        <small>
                            {%if post.edited%}
                                {{post.editedAt}}- Edited 
                            {%else%}
                                {{post.createdAt}} 
                            {%endif%}
                        </small>
                    </div>
                    <div class="m-1" id="post_content-{{post.id}}">
                        {{post.content}}
                    </div>
                    <div class="d-flex">
                        <form id="like_post_form_{{post.id}}">
                            <input type="text" value="{{post.id}}" hidden>
                            <button class="btn btn-none border-0 p-0 like_post_btn" type="submit">
                                <i class="mx-1 fa fa-heart"></i>
                                <span id="span_like_{{post.id}}">{{post.likes.all | length}}</span>
                            </button>
                        </form>
                    </div>
                </div>
                {%endfor%}
                <div class="d-flex justify-content-center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            {%if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only">Previous</span>
                                </a>
                            </li>
                            {%endif%} 
                            
                            <li class="page-item"><a class="page-link" href="?page={{current_page}}">{{current_page}}</a></li>

                            {%if last_page != 1 and current_page < last_page%}
                            <li class="page-item">
                                <a class="page-link" href="?page={{current_page|add:'1'}}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only">Next</span>
                                </a>
                            </li>
                            {%endif%}
                        </ul>
                    </nav>
                </div>
            {%else%}
                <div class="d-flex justify-content-center" id="nopost">
                    <p>No posts yet!</p>    
                </div>
            {%endif%}
        </div>
    </div>
{% endblock %}


{% block javascript %}

    <script src="{% static 'network/helpers.js' %}"></script>

    <script>
        let follow = (e) => {
            let user_id = e.target.previousElementSibling.value;
            $("#follow_unfollow_user").submit(function (e) {
                // preventing from page reload and default actions
                e.preventDefault();
                // make POST ajax call
                $.ajax({
                    type: 'POST',
                    url: `/follow/${user_id}`,
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}' 
                    },
                
                    success: function (response) {
                        let data = JSON.parse(response["ser_follower"]);
                        let username = data[0]["fields"].username;
                        let id = data[0]["fields"].id;
                        let isfollowed = JSON.parse(response['followed']);
                        let number_of_followers = JSON.parse(response['number_of_followers']);
                       
                        if(isfollowed){
                            $("#follow_unfollow_user").html(
                                `
                                <input type="text" value="${id}" hidden>
                                <button type="submit" id="follow_unfollow" class="btn btn-danger">Unfollow ${username}</button>
                                
                               
                                 `
                            )
                        }
                        else{
                            $("#follow_unfollow_user").html(
                                `
                                <input type="text" value="${id}" hidden>
                                <button type="submit" id="follow_unfollow" class="btn btn-primary">Follow ${username}</button>
                
                                `
                            )
                        }   

                        $("#num_followers").html(`
                            Followers ${number_of_followers}
                        `)
                    },
                    error: function (response) {
                        // alert the error if any error occured
                        console.log("something bad happend!")
                    }
                }) 
            });  
        }
        
        let unFollow = document.querySelector('#follow_unfollow');
        unFollow.addEventListener('click', follow);

    </script>
    
    <script>
        let post = document.querySelectorAll(".edit_btn");
        let like_btn = document.querySelectorAll(".like_post_btn");

        post.forEach((item) => {
            item.addEventListener('click', clicked);
        })
    
        like_btn.forEach((btn) => {
            btn.addEventListener('click', like_post);
        })
    </script>

    <script>
        $("#new_posts").on('DOMNodeInserted', function(e) {
            // like post 
            let like_btn = document.querySelectorAll(".like_post_btn");
            
            if(like_btn){
                like_btn.forEach((btn) => {
                    btn.addEventListener('click', like_post);
                })
            }

            // editing a post
            let post = document.querySelectorAll(".edit_btn");
            if(post){
                post.forEach((item) => {
                    item.addEventListener('click', clicked);
                })
            }
        });
    </script>
    
{%endblock%}